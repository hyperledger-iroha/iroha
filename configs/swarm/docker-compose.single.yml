# This file is generated by iroha_swarm.
# Do not edit it manually.

version: '3.8'
services:
  irohad0:
    build: ../..
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed012082528CCC8727333530C8F6F19F70C23882DEB1BF2BA3BE4A6654C7E8A91A7731
      PRIVATE_KEY: 802640418A3712F4841FFE7A90B14E90BF76A6EF2A2546AC8DBBB1F442FFB8250426B082528CCC8727333530C8F6F19F70C23882DEB1BF2BA3BE4A6654C7E8A91A7731
      P2P_ADDRESS: 0.0.0.0:1337
      API_ADDRESS: 0.0.0.0:8080
      GENESIS_PUBLIC_KEY: ed01204164BF554923ECE1FD412D241036D863A6AE430476C898248B8237D77534CFC4
      GENESIS_SIGNED_FILE: /tmp/genesis.signed.scale
      GENESIS_PRIVATE_KEY: 80264082B3BDE54AEBECA4146257DA0DE8D59D8E46D5FE34887DCD8072866792FCB3AD4164BF554923ECE1FD412D241036D863A6AE430476C898248B8237D77534CFC4
      TOPOLOGY: '[{"address":"irohad0:1337","public_key":"ed012082528CCC8727333530C8F6F19F70C23882DEB1BF2BA3BE4A6654C7E8A91A7731"}]'
    ports:
    - 1337:1337
    - 8080:8080
    volumes:
    - ./:/config
    init: true
    command: |-
      /bin/sh -c "
      EXECUTOR_RELATIVE_PATH=$(jq -r '.executor' /config/genesis.json) && \\
      EXECUTOR_ABSOLUTE_PATH=$(realpath \"/config/$$EXECUTOR_RELATIVE_PATH\") && \\
      jq \\
          --arg executor \"$$EXECUTOR_ABSOLUTE_PATH\" \\
          --argjson topology \"$$TOPOLOGY\" \\
          '.executor = $$executor | .topology = $$topology' /config/genesis.json \\
          >/tmp/genesis.json && \\

      kagami genesis sign /tmp/genesis.json \\
          --public-key $$GENESIS_PUBLIC_KEY \\
          --private-key $$GENESIS_PRIVATE_KEY \\
          --out-file $$GENESIS_SIGNED_FILE \\
      && \\

      irohad --submit-genesis
      "
    healthcheck:
      test: test $(curl -s http://127.0.0.1:8080/status/blocks) -gt 0
      interval: 2s
      timeout: 1s
      retries: 30
      start_period: 4s
