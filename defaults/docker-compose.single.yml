# Generated by `kagami swarm`.
# You should not edit this manually.
# Seed: Iroha

services:
  irohad0:
    image: hyperledger/iroha:local
    build: ..
    pull_policy: never
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed0120A98BAFB0663CE08D75EBD506FEC38A84E576A7C9B0897693ED4B04FD9EF2D18D
      PRIVATE_KEY: 802620A4DFC16789FBF9A588525E4AC7F791AC51B12AEE8919EACC03EB2FC31D32C692
      P2P_PUBLIC_ADDRESS: irohad0:1337
      P2P_ADDRESS: 0.0.0.0:1337
      API_ADDRESS: 0.0.0.0:8080
      GENESIS: /tmp/genesis.json
      TOPOLOGY: '["ed0120A98BAFB0663CE08D75EBD506FEC38A84E576A7C9B0897693ED4B04FD9EF2D18D"]'
    ports:
    - 1337:1337
    - 8080:8080
    volumes:
    - ./genesis.json:/config/genesis.json:ro
    - ./client.toml:/config/client.toml:ro
    init: true
    healthcheck:
      test: test $(curl -s http://127.0.0.1:8080/status/blocks) -gt 0
      interval: 2s
      timeout: 1s
      retries: 30
      start_period: 4s
    command: |-
      /bin/sh -c "
          EXECUTOR_RELATIVE_PATH=$(jq -r '.executor' /config/genesis.json) && \\
          EXECUTOR_ABSOLUTE_PATH=$(realpath \"/config/$$EXECUTOR_RELATIVE_PATH\") && \\
          WASM_DIR_RELATIVE_PATH=$(jq -r '.wasm_dir' /config/genesis.json) && \\
          WASM_DIR_ABSOLUTE_PATH=$(realpath \"/config/$$WASM_DIR_RELATIVE_PATH\") && \\
          jq \\
              --arg executor \"$$EXECUTOR_ABSOLUTE_PATH\" \\
              --arg wasm_dir \"$$WASM_DIR_ABSOLUTE_PATH\" \\
              --argjson topology \"$$TOPOLOGY\" \\
              '.executor = $$executor | .wasm_dir = $$wasm_dir | .topology = $$topology' /config/genesis.json \\
              >$$GENESIS && \\
          exec irohad
      "
